---json
{
  "eleventyExcludeFromCollections": true
}
---
{#
  Outputs an Atom feed
  Key properties
  - collectioName: string
  - title: defaults to site.title
  - description: defaults to site.description
  - url: path of HTML file that this feed represents defaults to root
#}
{%- set feedCollection = (collections[collectionName] | reverse).slice(0,31) -%}
{%- set alternateUrl = url | default ("/") | replace(" ", "%20") | addBaseUrl -%}
{# add bridgy fed syndication for RSS based webmention sender -#}
{%- set rawBridgyFed -%}
{%- if page.url == "/feed-all.xml" -%}
  <a href="https://fed.brid.gy/" class="u-bridgy-fed" aria-hidden="true" tabindex="-1"></a>
{%- endif -%}{%- endset -%}
{%- set bridgyFed = rawBridgyFed | htmlToAbsoluteUrls(alternateUrl) -%}
<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet href="/assets/feed.xsl" type="text/xsl"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>{{ title | default(site.title) }}</title>
  <subtitle>{{ description | default(site.description) }}</subtitle>
  <link href="{{ page.url | replace(" ", "%20") | addBaseUrl }}" rel="self" type="application/atom+xml"/>
  <link href="{{ alternateUrl }}" rel="alternate" type="text/html"/>
  <updated>{{ feedCollection | getNewestCollectionItemDate | dateToRfc3339 }}</updated>
  <id>{{ alternateUrl }}</id>
  <author>
    <name>Anthony Ciccarello</name>
    <email>{{ site.email }}</email>
  </author>
  {%- for post in feedCollection %}
    {%- set absolutePostUrl %}{{ post.url | url | addBaseUrl }}{% endset %}
    {%- set postImage %}
    {%- if post.data.image -%}
      <figure>
        <img src="{{ post.data.image }}" alt="{{ post.data.image_alt | escape }}"/>
        {%- if image_caption %}
          <figcaption class="mdc-typography--caption">
            {{ post.data.image_caption | markdownify }}
          </figcaption>
        {%- endif %}
      </figure>
    {%- endif %}{% endset %}
    {%- set content %}
    {%- if post.data.type == "link" %}
      {{ post.data.responseData.plaintextSummary }}
      {%- if post.data.responseData.content %}:
          "{{ post.data.responseData.content | striptags(true) | truncate(300) | escape | nl2br }}"
        {%- endif %}
    {%- else -%}
      {{ post.templateContent }}
    {%- endif %}{% endset %}
    <entry>
      <title type="text">{{ post.data.title or post.data.defaultTitle }}</title>
      <link href="{{ absolutePostUrl }}" rel="alternate" type="text/html"/>
      <updated>{{ post.date | dateToRfc3339 }}</updated>
      <id>{{ absolutePostUrl }}</id>
      {%- for tag in post.data.tags %}
        <category term="{{ tag }}"/>
      {%- endfor %}
      {%- if loop.index <= 10 %}
        <content type="html">
          {{- postImage | htmlToAbsoluteUrls(absolutePostUrl) }}
          {{ content | sanitizeFeedContent | htmlToAbsoluteUrls(absolutePostUrl) }}
          {{ bridgyFed }}
        </content>
      {%- else %}
        <summary type="html">
          {{- postImage | htmlToAbsoluteUrls(absolutePostUrl) }}
          {%- set contentSummary -%}
          <p>{{ content | striptags | truncate(500) }}</p>
          <a href="{{ absolutePostUrl }}">Read More</a>
          {%- endset -%}
          {{ contentSummary }}
        </summary>
      {%- endif %}
    </entry>
  {%- endfor %}
</feed>